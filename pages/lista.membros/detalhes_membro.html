<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/auth-guard.js"></script>
    <title>Detalhes do Membro</title>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="/pages/styles/global.css">
    <link rel="stylesheet" href="/pages/styles/tabelas-abas.css">
    <link rel="stylesheet" href="/pages/lista.membros/detalhes.css">
    <link rel="stylesheet" href="/components/menu.css">
    <link rel="stylesheet" href="/components/notifications.css">
    <script src="/auth-guard.js"></script>
</head>
<body>
    <header id="menu-placeholder"></header>

    <main class="conteudo">
        <h1 id="membroNome" class="title-page">Carregando...</h1>
        <div class="detalhes-container" id="detalhesDoMembro">
            <div id="detalhes-header-placeholder"><!-- O cabeçalho será inserido aqui --></div>
            <div id="detalhes-body-placeholder"><!-- O conteúdo das abas será inserido aqui --></div>
        </div>
    </main>

    <div id="modal-financeiro" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" id="btn-fechar-modal">&times;</button>
            <h2 id="modal-titulo-financeiro">Histórico de Contribuições</h2>
            <div id="modal-corpo-financeiro"></div>
        </div>
    </div>

    <script src="/js/global-loader.js" defer></script>
    <script src="/js/api.js"></script>
    <script>
        function imprimirComprovante(lancamento) {
            const conteudo = `
                <div style="font-family: Arial, sans-serif; width: 80mm; margin: 0 auto; padding: 10px;">
                    <h2 style="text-align: center; margin: 0;">ADTC - Tabernáculo Celeste</h2>
                    <p style="text-align: center; font-size: 12px; border-bottom: 1px dashed #000; padding-bottom: 10px;">Comprovante de Contribuição</p>
                    <p><strong>Membro:</strong> ${lancamento.membroNome}</p>
                    <p><strong>Data:</strong> ${new Date(lancamento.data).toLocaleDateString('pt-BR')}</p>
                    <p><strong>Categoria:</strong> ${lancamento.categoria}</p>
                    <p><strong>Descrição:</strong> ${lancamento.descricao}</p>
                    <h3 style="text-align: right; margin-top: 15px;">Valor: R$ ${lancamento.valor.toFixed(2).replace('.', ',')}</h3>
                    <p style="font-size: 10px; text-align: center; margin-top: 20px;">Agradecemos a sua fidelidade e contribuição.</p>
                </div>
            `;
            const win = window.open('', '_blank');
            win.document.write(`<html><head><title>Comprovante</title></head><body onload="window.print();window.close()">${conteudo}</body></html>`);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // --- Seletores do DOM ---
            const membroNomeH1 = document.getElementById('membroNome');
            const detalhesContainer = document.getElementById('detalhesDoMembro');
            const headerPlaceholder = document.getElementById('detalhes-header-placeholder');
            const bodyPlaceholder = document.getElementById('detalhes-body-placeholder');
            const urlParams = new URLSearchParams(window.location.search);
            const membroId = urlParams.get('id');

            // --- Funções Auxiliares ---
            function calcularIdade(dataNascimento) {
                if (!dataNascimento) return 'Não informada';
                try {
                    const hoje = new Date();
                    const nascimento = new Date(dataNascimento);
                    if (isNaN(nascimento.getTime())) return 'Data inválida';

                    let idade = hoje.getFullYear() - nascimento.getFullYear();
                    const mes = hoje.getMonth() - nascimento.getMonth();
                    if (mes < 0 || (mes === 0 && hoje.getDate() < nascimento.getDate())) {
                        idade--;
                    }
                    return idade >= 0 ? `${idade} anos` : 'Data inválida';
                } catch (e) {
                    return 'Data inválida';
                }
            }

            function capitalizar(str) {
                if (!str) return '';
                return str.charAt(0).toUpperCase() + str.slice(1);
            }

            function formatarData(data) {
                if (!data) return 'Não informado';
                return new Date(data).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
            }

            if (!membroId) {
                membroNomeH1.textContent = 'Erro: ID do membro não encontrado.';
                detalhesContainer.innerHTML = '<p>O ID do membro não foi fornecido na URL.</p>';
                return;
            }

            // --- Lógica Principal ---
            window.api.get(`/api/membros/${membroId}`)
                .then(membro => {
                    membroNomeH1.textContent = `Detalhes do Membro`;

                    // --- Renderização do HTML ---
                    const headerHTML = `
                        <div class="detalhes-header">
                            ${membro.fotoUrl ? `<img src="${membro.fotoUrl}" alt="Foto de ${membro.nome}" class="detalhe-foto" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">` : ''}
                            <div class="detalhe-foto-placeholder" style="${membro.fotoUrl ? 'display:none;' : 'display:flex;'}"><i class='bx bx-user-circle'></i></div>
                            <div class="membro-titulo-info">
                                <h2>${membro.nome}</h2>
                                <p>${capitalizar(membro.cargoEclesiastico) || 'Não definido'}</p>
                                <div class="detalhes-acoes">
                                    <button id="btn-editar" class="btn-acao-detalhe btn-editar"><i class='bx bxs-edit'></i> Editar</button>
                                    <div class="dropdown">
                                        <button class="btn-acao-detalhe btn-imprimir"><i class='bx bxs-id-card'></i> Cartão</button>
                                        <div class="dropdown-content">
                                            <a id="link-personalizar-cartao" href="#"><i class='bx bxs-paint'></i> Imprimir Cartão Físico</a>
                                            <a id="link-ver-cartao-virtual" href="#" target="_blank"><i class='bx bx-link-external'></i> Ver Cartão Virtual</a>
                                            <a id="btn-copiar-link-virtual" href="#"><i class='bx bx-copy'></i> Copiar Link</a>
                                        </div>
                                    </div>
                                    <button id="btn-excluir" class="btn-acao-detalhe btn-perigo"><i class='bx bxs-trash'></i> Excluir</button>
                                    <a href="/pages/lista.membros/lista.membros.html" class="btn-acao-detalhe btn-voltar"><i class='bx bx-arrow-back'></i> Voltar</a>
                                </div>
                            </div>
                        </div>
                    `;

                    const bodyHTML = `
                        <nav class="detalhes-nav">
                            <button class="tab-link active" data-tab="pessoal">Dados Pessoais</button>
                            <button class="tab-link" data-tab="financeiro">Financeiro</button>
                            <button class="tab-link" data-tab="contato">Contato e Endereço</button>
                            <button class="tab-link" data-tab="ministerial">Dados Ministeriais</button>
                            <button class="tab-link" data-tab="outros">Outras Informações</button>
                        </nav>
                        <div class="detalhes-conteudo">
                            <div id="pessoal" class="tab-pane active">
                                <div class="info-grid">
                                    <div class="info-group">
                                        <h4>Identificação</h4>
                                        <div class="info-item"><strong>Nome Completo:</strong> <span>${membro.nome || 'Não informado'}</span></div>
                                        <div class="info-item"><strong>CPF:</strong> <span>${membro.cpf || 'Não informado'}</span></div>
                                        <div class="info-item"><strong>RG:</strong> <span>${membro.rg || 'Não informado'}</span></div>
                                        <div class="info-item"><strong>Data de Nascimento:</strong> <span>${formatarData(membro.dataNascimento)}</span></div>
                                        <div class="info-item"><strong>Idade:</strong> <span>${calcularIdade(membro.dataNascimento)}</span></div>
                                        <div class="info-item"><strong>Gênero:</strong> <span>${capitalizar(membro.genero) || 'Não informado'}</span></div>
                                        <div class="info-item"><strong>Naturalidade:</strong> <span>${membro.naturalidade || 'Não informada'}</span></div>
                                    </div>
                                    <div class="info-group">
                                        <h4>Família</h4>
                                        <div class="info-item"><strong>Filiação:</strong> <span>${membro.filiacao || 'Não informada'}</span></div>
                                        <div class="info-item"><strong>Estado Civil:</strong> <span>${capitalizar(membro.estadoCivil) || 'Não informado'}</span></div>
                                        ${membro.estadoCivil === 'casado' && membro.dataCasamento ? `<div class="info-item"><strong>Data Casamento:</strong> <span>${formatarData(membro.dataCasamento)}</span></div>` : ''}
                                        ${membro.nomeConjuge ? `<div class="info-item"><strong>Cônjuge:</strong> <span>${membro.nomeConjuge}</span></div>` : ''}
                                        <div class="info-item"><strong>Filhos:</strong> <span>${membro.filhos && membro.filhos.length > 0 ? `<ul>${membro.filhos.map(f => `<li>${f.nome} (${formatarData(f.dataNascimento)})</li>`).join('')}</ul>` : 'Não informado'}</span></div>
                                    </div>
                                </div>
                            </div>
                            <div id="financeiro" class="tab-pane">
                                <h4>Histórico de Contribuições</h4>
                                <div id="historico-financeiro-container"><p>Carregando histórico...</p></div>
                            </div>
                            <div id="contato" class="tab-pane">
                                <div class="info-grid">
                                    <div class="info-group">
                                        <h4>Contato</h4>
                                        <div class="info-item"><strong>Telefone:</strong> <span>${membro.telefone || 'Não informado'}</span></div>
                                        <div class="info-item"><strong>E-mail:</strong> <span>${membro.email || 'Não informado'}</span></div>
                                    </div>
                                    <div class="info-group">
                                        <h4>Endereço</h4>
                                        <div class="info-item"><strong>Endereço:</strong> <span>${membro.endereco || 'Não informado'}</span></div>
                                        <div class="info-item"><strong>Bairro:</strong> <span>${membro.bairro || 'Não informado'}</span></div>
                                        <div class="info-item"><strong>Cidade:</strong> <span>${membro.cidade || 'Não informado'}</span></div>
                                        <div class="info-item"><strong>Estado:</strong> <span>${membro.estado || 'Não informado'}</span></div>
                                    </div>
                                </div>
                            </div>
                            <div id="ministerial" class="tab-pane">
                                <div class="info-grid">
                                    <div class="info-group">
                                        <h4>Vida Cristã</h4>
                                        <div class="info-item"><strong>Data de Conversão:</strong> <span>${formatarData(membro.dataConversao)}</span></div>
                                        <div class="info-item"><strong>Batismo nas Águas:</strong> <span>${membro.batismoAguas === 'sim' ? `Sim, em ${formatarData(membro.dataBatismo)}` : 'Não'}</span></div>
                                        <div class="info-item"><strong>Batismo no Espírito Santo:</strong> <span>${membro.batismoEspiritoSanto === 'sim' ? `Sim, em ${formatarData(membro.dataBatismoEspiritoSanto)}` : 'Não'}</span></div>
                                        <div class="info-item"><strong>Veio de outra Igreja:</strong> <span>${membro.veioDeOutraIgreja === 'sim' ? `Sim (${membro.nomeOutraIgreja || 'Não especificada'})` : 'Não'}</span></div>
                                    </div>
                                    <div class="info-group">
                                        <h4>Envolvimento</h4>
                                        <div class="info-item"><strong>Cargo Eclesiástico:</strong> <span>${capitalizar(membro.cargoEclesiastico) || 'Não definido'}</span></div>
                                        <div class="info-item"><strong>Pequeno Grupo:</strong> <span>${membro.grupoPequeno?.nome || 'Nenhum'}</span></div>
                                        <div class="info-item"><strong>Ministério:</strong> <span>${membro.temMinisterio === 'sim' ? (membro.ministerio === 'outro' ? membro.nomeOutroMinisterio : capitalizar(membro.ministerio)) : 'Não participa'}</span></div>
                                        ${membro.temMinisterio === 'sim' ? `<div class="info-item"><strong>Função no Ministério:</strong> <span>${capitalizar(membro.cargoMinisterio) || 'Não informado'}</span></div>` : ''}
                                        ${membro.dons && membro.dons.length > 0 ? `<div class="info-item"><strong>Dons e Talentos:</strong> <span>${membro.dons.map(d => capitalizar(d.replace(/_/g, ' '))).join(', ')}</span></div>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div id="outros" class="tab-pane">
                                <div class="info-grid">
                                    <div class="info-group">
                                        <h4>Informações Adicionais</h4>
                                        <div class="info-item"><strong>Profissão:</strong> <span>${membro.profissao || 'Não informada'}</span></div>
                                        <div class="info-item"><strong>Escolaridade:</strong> <span>${membro.escolaridade ? capitalizar(membro.escolaridade.replace(/_/g, ' ')) : 'Não informada'}</span></div>
                                        <div class="info-item"><strong>Como nos conheceu:</strong> <span>${membro.comoConheceuIgreja || 'Não informado'}</span></div>
                                        <div class="info-item"><strong>Restrição de Saúde:</strong> <span>${membro.restricaoSaude || 'Nenhuma'}</span></div>
                                    </div>
                                    <div class="info-group">
                                        <h4>Consentimentos (LGPD)</h4>
                                        <div class="info-item"><strong>Autoriza Comunicados:</strong> <span>${capitalizar(membro.autorizaComunicados) || 'Não'}</span></div>
                                        <div class="info-item"><strong>Autoriza Uso de Imagem:</strong> <span>${capitalizar(membro.autorizaImagem) || 'Não'}</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    headerPlaceholder.innerHTML = headerHTML;
                    bodyPlaceholder.innerHTML = bodyHTML;

                    // --- Adiciona Event Listeners ---
                    document.getElementById('btn-editar').addEventListener('click', () => { 
                        window.location.href = `/pages/cadastro.membro.page/cadastro.membro.html?id=${membroId}`; 
                    });

                    // Links do cartão
                    const linkVirtualRelativo = `cartao_virtual.html?id=${membroId}`;
                    document.getElementById('link-personalizar-cartao').href = `cartao_membro.html?id=${membroId}`;
                    document.getElementById('link-ver-cartao-virtual').href = linkVirtualRelativo;

                    // --- ADICIONADO: Lógica para copiar o link ---
                    document.getElementById('btn-copiar-link-virtual').addEventListener('click', (e) => {
                        e.preventDefault(); // Previne a navegação do link
                        const urlCompleta = new URL(linkVirtualRelativo, window.location.href).href;
                        navigator.clipboard.writeText(urlCompleta).then(() => {
                            alert('Link do Cartão Virtual copiado para a área de transferência!');
                        }).catch(err => {
                            console.error('Erro ao copiar o link: ', err);
                            alert('Não foi possível copiar o link.');
                        });
                    });
                    
                    document.getElementById('btn-excluir').addEventListener('click', async () => {
                        if (confirm('Tem certeza que deseja excluir este membro? Esta ação não pode ser desfeita.')) {
                            try {
                                await window.api.delete(`/api/membros/${membroId}`);
                                alert('Membro excluído com sucesso!');
                                window.location.href = '/pages/lista.membros/lista.membros.html';
                            } catch (error) {
                                console.error('Erro ao excluir membro:', error);
                                alert('Falha ao excluir membro.');
                            }
                        }
                    });

                    // Lógica das abas
                    const tabLinks = document.querySelectorAll('.tab-link');
                    const tabPanes = document.querySelectorAll('.tab-pane');
                    tabLinks.forEach(link => {
                        link.addEventListener('click', () => {
                            const tabId = link.dataset.tab;
                            tabLinks.forEach(l => l.classList.remove('active'));
                            link.classList.add('active');
                            tabPanes.forEach(pane => pane.classList.remove('active'));
                            document.getElementById(tabId).classList.add('active');

                            // Carrega o histórico financeiro ao clicar na aba
                            if (tabId === 'financeiro' && !document.getElementById('historico-financeiro-container').hasAttribute('data-loaded')) {
                                carregarHistoricoFinanceiro(membro);
                            }
                        });
                    });

                    // Função para carregar o histórico financeiro na aba
                    const carregarHistoricoFinanceiro = async (membro) => {
                        const container = document.getElementById('historico-financeiro-container');
                        try {
                            const contribuicoes = await window.api.get(`/api/membros/${membroId}/contribuicoes`);
                            container.setAttribute('data-loaded', 'true'); // Marca como carregado
                            if (contribuicoes.length === 0) {
                                container.innerHTML = '<p>Nenhuma contribuição encontrada para este membro.</p>';
                            } else {
                                container.innerHTML = `
                                    <table class="tabela-contribuicoes">
                                        <thead><tr><th>Data</th><th>Descrição</th><th>Valor</th><th>Ações</th></tr></thead>
                                        <tbody>
                                            ${contribuicoes.map(c => `<tr><td>${new Date(c.data).toLocaleDateString('pt-BR')}</td><td>${c.descricao}</td><td>R$ ${c.valor.toFixed(2)}</td><td><button class="btn-imprimir-comprovante" data-id="${c._id}">Imprimir</button></td></tr>`).join('')}
                                        </tbody>
                                    </table>`;
                                container.querySelectorAll('.btn-imprimir-comprovante').forEach(btn => btn.addEventListener('click', (e) => {
                                    const lancamento = contribuicoes.find(c => c._id === e.target.dataset.id);
                                    imprimirComprovante({ ...lancamento, membroNome: membro.nome });
                                }));
                            }
                        } catch (error) { 
                            console.error('Erro ao buscar histórico financeiro:', error); 
                            container.innerHTML = '<p>Erro ao buscar histórico financeiro.</p>';
                        }
                    };
                })
                .catch(error => {
                    console.error('Erro ao buscar detalhes do membro:', error);
                    membroNomeH1.textContent = 'Erro ao carregar detalhes do membro.';
                    detalhesContainer.innerHTML = '<p>Não foi possível carregar os detalhes do membro. Verifique se o ID é válido e tente novamente mais tarde.</p>';
                });
        });
    </script>
</body>
</html>
