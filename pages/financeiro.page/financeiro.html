<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/auth-guard.js"></script>
    <title>Controle Financeiro</title>
    
    <link rel="stylesheet" href="/pages/financeiro.page/financeiro.css">
    <link rel="stylesheet" href="/pages/styles/global.css"> 
    <link rel="stylesheet" href="/components/menu.css">
    <link rel="stylesheet" href="/components/notifications.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/auth-guard.js"></script>
</head>
<body data-theme="light">
<header id="menu-placeholder"></header>

<main class="conteudo">
    <h1 class="title-page">Painel Financeiro</h1>

    <div class="abas-financeiro">
        <button class="aba-link active" data-aba="lancamentos">Lançamentos</button>
        <button class="aba-link" data-aba="dizimos">Dízimos e Ofertas</button>
    </div>

    <div id="lancamentos" class="aba-conteudo active">
        <section class="dashboard-financeiro">
            <div class="card-dashboard" id="card-receitas"><p>Receitas (Período)</p><h2 id="total-receitas">R$ 0,00</h2></div>
            <div class="card-dashboard" id="card-despesas"><p>Despesas (Período)</p><h2 id="total-despesas">R$ 0,00</h2></div>
            <div class="card-dashboard" id="card-saldo"><p>Balanço (Período)</p><h2 id="balanco-mensal">R$ 0,00</h2></div>
        </section>
        
        <div class="analises-container">
            <section class="grafico-container">
                <div class="grafico-header">
                    <h3>Resumo Anual (<span id="grafico-ano-titulo"></span>)</h3>
                </div>
                <div id="grafico-body" class="grafico-body">
                    <canvas id="grafico-mensal"></canvas>
                </div>
            </section>
            <section class="grafico-container">
                <div class="grafico-header">
                    <h3>Despesas por Categoria (Período)</h3>
                </div>
                <div class="grafico-body" id="grafico-pizza-container"><canvas id="grafico-despesas-pizza"></canvas></div>
            </section>
        </div>

        <section class="lancamentos-container">
            <div class="lancamentos-header">
                <h2>Extrato de Lançamentos</h2>
                <div class="header-actions">
                    <button id="btn-excluir-selecionados" class="btn-perigo hidden"><i class='bx bxs-trash'></i> Excluir Selecionados</button>
                    <button id="btn-exportar-pdf" class="btn-secundario"><i class='bx bxs-file-pdf'></i> Exportar PDF</button>
                    <button id="btn-novo-lancamento" class="btn-principal">+ Novo Lançamento</button>
                </div>
            </div>
            
            <div class="filtros-container">
                <label for="filtro-ano">Ano:</label>
                <select id="filtro-ano"></select>
                <label for="filtro-mes">Mês:</label>
                <select id="filtro-mes"></select>
                <label for="filtro-categoria">Categoria:</label>
                <select id="filtro-categoria"></select>
                <label for="filtro-tipo">Tipo:</label>
                <select id="filtro-tipo">
                    <option value="todos">Todos</option>
                    <option value="entrada">Entradas</option>
                    <option value="saida">Saídas</option>
                </select>
            </div>

            <table class="tabela-lancamentos">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selecionar-todos-lancamentos" title="Selecionar Todos"></th>
                        <th>Data</th><th>Descrição</th>
                        <th>Categoria</th>
                        <th>Valor</th>
                        <th>Ações</th>
                    </tr></thead>
                <tbody id="tabela-lancamentos-corpo"></tbody>
            </table>
        </section>
    </div>

    <div id="dizimos" class="aba-conteudo">
    <section class="dizimos-busca-container">
        <h2>Controle de Contribuições por Membro</h2>
        <p>Busque um membro pelo nome para visualizar ou registrar dízimos e ofertas.</p>
        <div class="form-group">
            <input type="text" id="busca-membro-input" placeholder="Digite o nome do membro..." autocomplete="off">
            <div id="busca-membro-resultados"></div>
        </div>
    </section>

    <section id="historico-membro-container" class="hidden">
        <div class="historico-header">
            <div>
                <p class="historico-subtitulo">Histórico de Contribuições de:</p>
                <h3 id="historico-membro-nome"></h3>
            </div>
            <div class="header-actions">
                <button id="btn-imprimir-relatorio-membro" class="btn-secundario"><i class='bx bxs-printer'></i> Imprimir Relatório</button>
                <button id="btn-novo-dizimo-membro" class="btn-principal">+ Nova Contribuição</button>
            </div>
        </div>

        <div class="dashboard-financeiro-membro">
             <div class="card-dashboard" id="card-total-anual">
                 <p>Total Contribuído (<span id="ano-corrente-historico"></span>)</p>
                 <h2 id="total-anual-membro">R$ 0,00</h2>
             </div>
        </div>

        <table class="tabela-lancamentos">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Categoria</th>
                    <th>Descrição</th>
                    <th>Valor</th>
                </tr>
            </thead>
            <tbody id="tabela-historico-corpo">
                </tbody>
             <tfoot>
                <tr>
                    <td colspan="3">Total Geral do Histórico</td>
                    <td id="total-geral-historico">R$ 0,00</td>
                </tr>
            </tfoot>
        </table>

        <section class="grafico-container-membro">
            <div class="grafico-header">
                <h3>Contribuições Mensais (<span id="grafico-ano-membro"></span>)</h3>
            </div>
            <div id="grafico-contribuicoes-container" class="grafico-body"></div>
        </section>
        
        <div id="aviso-sem-historico" class="aviso-historico hidden">
            <p>Nenhuma contribuição encontrada para este membro.</p>
        </div>
    </section>
    
    <section id="aviso-inicial-dizimos" class="aviso-historico">
        <i class='bx bx-search-alt' style="font-size: 4rem; color: #ccc;"></i>
        <p>Utilize a busca acima para encontrar um membro.</p>
    </section>
</div>
</main>
    
<div id="modal-lancamento" class="modal-overlay">
    <div class="modal-content">
        <form id="form-lancamento">
            <h2 id="modal-titulo">Novo Lançamento</h2>
            <div class="form-group"><label for="tipo">Tipo de Lançamento</label><select id="tipo" required><option value="entrada">Entrada (Receita)</option><option value="saida">Saída (Despesa)</option></select></div>
            <div class="form-group"><label for="data">Data</label><input type="date" id="data" required></div>
            <div class="form-group"><label for="valor">Valor (R$)</label><input type="number" step="0.01" min="0" id="valor" placeholder="Ex: 150.00" required></div>
            <div class="form-group"><label for="categoria">Categoria</label><select id="categoria" required></select></div>
            <div class="form-group hidden" id="grupo-membro">
                <label for="busca-membro-modal">Membro</label>
                <div class="input-wrapper">
                    <input type="text" id="busca-membro-modal" placeholder="Busque por nome ou CPF..." autocomplete="off">
                    <button type="button" id="clear-membro-btn" class="btn-clear hidden" title="Limpar seleção">&times;</button>
                </div>
                <input type="hidden" id="membroId-hidden">
                <div id="busca-membro-resultados-modal" class="busca-resultados-modal"></div>
                <p class="form-text-helper">Deixe em branco para registrar como contribuição anônima.</p>
            </div>
            <div class="form-group"><label for="descricao">Descrição</label><input type="text" id="descricao" placeholder="Ex: Dízimo do membro, Conta de Luz" required></div>
            <div class="form-group"><label for="comprovante">Anexar Comprovante (Opcional)</label><input type="file" id="comprovante" accept="image/*,application/pdf"></div>
            <div id="comprovante-atual-container" class="form-group hidden"><p>Comprovante Atual: <a id="comprovante-atual-link" href="#" target="_blank"></a></p></div>
            <div class="modal-actions"><button type="button" class="btn-secundario" data-close>Cancelar</button><button type="submit" class="btn-principal">Salvar</button></div>
        </form>
    </div>
</div>

<!-- Toast/Snackbar para Desfazer Exclusão -->
<div id="toast-desfazer" class="toast">
    <span id="toast-mensagem"></span>
    <button id="btn-desfazer" class="btn-toast">Desfazer</button>
</div>

<!-- Modelo do Recibo para Geração de Imagem/PDF -->
<div id="recibo-container" style="position: absolute; left: -9999px; width: 800px; padding: 20px; background-color: white;">
    <div id="recibo-template" style="border: 1px solid #ccc; padding: 0; font-family: 'Helvetica', sans-serif; color: #333;">
        <div style="background-color: #001f5d; color: white; padding: 15px 25px; display: flex; align-items: center; justify-content: flex-start;">
            <div style="display: flex; align-items: center;">
                <img src="/pages/logo.tab.png" alt="Logo da Igreja" style="width: 50px; height: auto; margin-right: 15px;">
                <h2 style="margin: 0; font-size: 20px; color: white; font-weight: 600;">ADTC - Tabernáculo Celeste</h2>
            </div>
        </div>
        <div style="padding: 40px;">
            <h3 style="text-align: center; margin-top: 0; margin-bottom: 30px; font-size: 22px; color: #333; font-weight: 600;">Recibo de Contribuição</h3>
            <div style="font-size: 16px; line-height: 1.6;">
                <p>Recebemos de <strong id="recibo-nome-membro"></strong>, o valor de <strong id="recibo-valor"></strong>, referente a <strong id="recibo-descricao"></strong>.</p>
                <p><strong>Data da Contribuição:</strong> <span id="recibo-data"></span></p>
                <p><strong>Categoria:</strong> <span id="recibo-categoria"></span></p>
            </div>
            <div style="margin-top: 40px; text-align: center; font-style: italic; color: #555;">
                <p>"Agradecemos sua contribuição."</p>
                <p style="font-size: 14px;">"Há quem dê generosamente, e vê aumentar suas riquezas; outros retêm o que deveriam dar, e caem na pobreza." (Provérbios 11:24)</p>
            </div>
            <div style="margin-top: 60px; text-align: center;">
                <div style="display: inline-block; border-top: 1px solid #888; padding-top: 5px; width: 250px;">
                    <p style="margin: 0; font-size: 14px;">Assinatura da Tesouraria</p>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Modal de Detalhes do Lançamento -->
<div id="modal-detalhes-lancamento" class="modal-overlay">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2 id="detalhes-titulo">Detalhes do Lançamento</h2>
            <button type="button" class="btn-close" data-close>&times;</button>
        </div>
        <div class="modal-body">
            <div class="detalhes-grid">
                <div class="detalhes-info">
                    <p><strong>Data:</strong> <span id="detalhes-data"></span></p>
                    <p><strong>Tipo:</strong> <span id="detalhes-tipo"></span></p>
                    <p><strong>Valor:</strong> <span id="detalhes-valor"></span></p>
                    <p><strong>Categoria:</strong> <span id="detalhes-categoria"></span></p>
                    <p><strong>Descrição:</strong> <span id="detalhes-descricao"></span></p>
                    <p id="detalhes-membro-container" class="hidden"><strong>Membro:</strong> <span id="detalhes-membro"></span></p>
                </div>
                <div class="detalhes-comprovante">
                    <h4>Comprovante</h4>
                    <div id="detalhes-comprovante-preview"></div>
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn-secundario" id="detalhes-btn-imprimir"><i class='bx bxs-printer'></i> Imprimir Recibo</button>
            <button type="button" class="btn-principal" id="detalhes-btn-compartilhar"><i class='bx bxs-share-alt'></i> Compartilhar</button>
            <button type="button" class="btn-secundario" data-close>Fechar</button>
        </div>
    </div>
</div>


<!-- Bibliotecas para Geração de PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script src="/js/global-loader.js" defer></script>
<script src="/pages/config.js"></script>
<script src="/pages/financeiro.page/financeiro.js"></script>

<!-- Menu de Contexto para a Tabela de Lançamentos -->
<div id="context-menu" class="context-menu">
    <ul>
        <li id="context-selecionar"><i class='bx bx-check-square'></i> Selecionar</li>
        <li id="context-editar"><i class='bx bxs-edit'></i> Editar</li>
        <li id="context-excluir"><i class='bx bxs-trash'></i> Excluir</li>
        <li id="context-copiar"><i class='bx bxs-copy'></i> Copiar Dados</li>
        <li id="context-imprimir"><i class='bx bxs-printer'></i> Imprimir Comprovante</li>
    </ul>
</div>

</body>
</html>